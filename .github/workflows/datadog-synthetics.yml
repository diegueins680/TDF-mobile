name: Run Datadog Synthetic tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  synthetics:
    name: Run Datadog Synthetic tests
    runs-on: ubuntu-latest
    env:
      DD_API_KEY: ${{ secrets.DD_API_KEY }}
      DD_APP_KEY: ${{ secrets.DD_APP_KEY }}

    # Do not run on PRs from forks (repo secrets are not available there).
    if: ${{ github.event_name != 'pull_request' || !github.event.pull_request.head.repo.fork }}

    steps:
      - name: Report missing Datadog secrets
        if: ${{ env.DD_API_KEY == '' || env.DD_APP_KEY == '' }}
        run: echo "Skipping Datadog synthetics — DD_API_KEY and/or DD_APP_KEY are not configured."

      - name: Checkout
        if: ${{ env.DD_API_KEY != '' && env.DD_APP_KEY != '' }}
        uses: actions/checkout@v4

      - name: Run Datadog Synthetic tests
        if: ${{ env.DD_API_KEY != '' && env.DD_APP_KEY != '' }}
        uses: DataDog/synthetics-ci-github-action@v3.8.1
        with:
          # REQUIRED — must be set in GitHub repo secrets (Settings → Secrets and variables → Actions)
          api-key: ${{ env.DD_API_KEY }}
          app-key: ${{ env.DD_APP_KEY }}

          # Change if your account is on a different Datadog site (e.g., datadoghq.eu, us3.datadoghq.com)
          datadog-site: datadoghq.com

          # Choose ONE of the two selectors below:

          # (A) Search query — ensure your Synthetic tests are tagged accordingly
          test-search-query: 'tag:e2e-tests'

          # (B) Public IDs — uncomment and list test IDs if you prefer explicit selection
          # public-ids: |
          #   abc-d3f-ghi
          #   jkl-mn0-pqr

          # Fail if the selector finds no tests (helps catch mis-tagging)
          fail-on-missing-tests: true
